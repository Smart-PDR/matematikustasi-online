<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
    <title>Matematik Ustasƒ± | Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;700;900&family=Fira+Code:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            --primary: #6c5ce7;
            --secondary: #00cec9;
            --accent: #ff7675;
            --dark: #2d3436;
            --light: #dfe6e9;
            --white: #ffffff;
            --success: #00b894;
            --danger: #d63031;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-gradient);
            color: var(--dark);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* DEVICE MODES */
        body.mode-phone { --btn-size: 50px; --font-scale: 0.8; --pad: 10px; }
        body.mode-tablet { --btn-size: 70px; --font-scale: 1; --pad: 20px; }
        body.mode-board { --btn-size: 90px; --font-scale: 1.3; --pad: 30px; }

        /* Minimalist Developer Signature */
        .dev-footer {
            margin-top: 25px; font-family: 'Fira Code', monospace; 
            font-size: 0.75rem; color: #b2bec3; opacity: 0.6;
            letter-spacing: 1px;
        }

        /* Sound Toggle */
        .sound-toggle {
            position: fixed; top: 15px; right: 15px;
            background: var(--white); border-radius: 50%;
            width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; cursor: pointer; z-index: 2000; box-shadow: var(--shadow);
            border: 2px solid var(--light); transition: 0.2s;
        }
        .sound-toggle:active { transform: scale(0.9); }

        /* Screens */
        .screen {
            position: fixed; inset: 0; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: var(--pad); overflow-y: auto; transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
            pointer-events: auto;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        
        /* Result Screen - Max Z-Index */
        #result-screen { z-index: 9000; }
        #result-screen .card { z-index: 9010; pointer-events: auto; }
        #confetti { z-index: 9005; pointer-events: none; }

        /* Cards */
        .card {
            background: var(--card-bg); padding: 25px; border-radius: 30px;
            box-shadow: var(--shadow); width: 100%; max-width: 550px; text-align: center;
            border: 4px solid var(--white); position: relative;
            max-height: 95vh; overflow-y: auto;
            z-index: 10;
        }

        h1, h2 { font-family: 'Fredoka', sans-serif; color: var(--primary); margin-bottom: 15px; line-height: 1.1; }
        h1 { font-size: calc(2.2rem * var(--font-scale)); }
        h2 { font-size: calc(1.8rem * var(--font-scale)); }

        .section-title {
            font-size: 0.9rem; font-weight: 800; color: #b2bec3; text-transform: uppercase;
            margin: 15px 0 8px; letter-spacing: 1px; display: block;
        }

        /* Buttons */
        .btn-group { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 10px; }
        .opt-btn {
            flex: 1; min-width: 80px; padding: 12px 5px; border: 2px solid var(--light);
            background: var(--white); border-radius: 15px; font-weight: 700; cursor: pointer;
            transition: 0.2s; color: var(--dark); font-size: 0.9rem; font-family: 'Nunito', sans-serif;
        }
        .opt-btn.active { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3); }

        .big-btn {
            width: 100%; padding: 16px; background: var(--success); color: white;
            border: none; border-radius: 20px; font-size: 1.3rem; font-weight: 800;
            margin-top: 20px; cursor: pointer; box-shadow: 0 6px 0 #009476; transition: 0.1s;
            font-family: 'Fredoka', sans-serif;
            position: relative; z-index: 20; pointer-events: auto;
        }
        .big-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #009476; }
        .big-btn.disabled { opacity: 0.6; pointer-events: none; filter: grayscale(1); }
        
        .btn-red { background: var(--danger); box-shadow: 0 6px 0 #c0392b; }
        .btn-red:active { box-shadow: 0 2px 0 #c0392b; }
        .btn-blue { background: #0984e3; box-shadow: 0 6px 0 #006eb3; }
        .btn-blue:active { box-shadow: 0 2px 0 #006eb3; }
        .btn-white { background: var(--white); color: var(--dark); box-shadow: 0 6px 0 #b2bec3; border: 2px solid var(--light); }
        .btn-white:active { box-shadow: 0 2px 0 #b2bec3; }

        /* Identity */
        .avatar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0; }
        .avatar-opt { font-size: 2.2rem; cursor: pointer; padding: 5px; border-radius: 12px; transition: 0.2s; border: 2px solid transparent; }
        .avatar-opt:hover { background: #f1f2f6; }
        .avatar-opt.selected { background: var(--warn); border-color: var(--accent); transform: scale(1.1); }
        
        .inp-text {
            width: 100%; padding: 15px; border: 3px solid var(--light); border-radius: 15px;
            font-family: 'Nunito', sans-serif; font-size: 1.2rem; text-align: center; font-weight: 800;
            outline: none; transition: 0.3s;
        }
        .inp-text:focus { border-color: var(--primary); background: #f8f7ff; }
        
        #room-join-code {
            font-size: 1.5rem; letter-spacing: 2px; border: 3px solid var(--primary);
            background: #fff; color: var(--primary); width: 140px; padding: 10px;
        }

        /* Online Lobby */
        .lobby-code-box {
            background: #f1f2f6; padding: 15px; border-radius: 20px; margin: 15px 0;
            border: 3px dashed #b2bec3; display: flex; align-items: center; justify-content: center; gap: 15px;
            cursor: pointer; position: relative;
        }
        .lobby-code { font-size: 3rem; font-weight: 900; color: var(--primary); letter-spacing: 5px; font-family: 'Fredoka', sans-serif; }
        .copy-icon { background: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .player-list { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .player-row {
            background: white; border: 2px solid var(--light); padding: 10px 15px; border-radius: 15px;
            display: flex; align-items: center; gap: 15px;
        }
        .player-row.ready { border-color: var(--success); background: #e3fcf7; }
        .p-avatar { font-size: 2rem; }
        .p-name { flex: 1; text-align: left; font-weight: 800; font-size: 1.1rem; }
        .p-status { font-size: 0.8rem; font-weight: 700; color: #b2bec3; }
        .badge-ready { background: var(--success); color: white; padding: 3px 10px; border-radius: 10px; font-size: 0.7rem; }
        
        .lobby-settings-box {
            background: #fff3cd; color: #856404; padding: 10px; border-radius: 15px; 
            font-size: 0.85rem; margin-bottom: 15px; border: 1px solid #ffeeba;
            text-align: left;
        }

        /* Game UI */
        #game-header {
            display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 600px;
            margin: 0 auto 10px; padding: 10px; background: rgba(255,255,255,0.8); border-radius: 20px;
        }
        .score-pill {
            background: var(--white); padding: 5px 15px; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; min-width: 80px;
            box-shadow: 0 4px 0 #dfe6e9; border: 1px solid #dfe6e9;
        }
        .score-pill.enemy { background: #ffeaa7; border-color: #fdcb6e; box-shadow: 0 4px 0 #fdcb6e; }
        .pill-label { font-size: 0.7rem; font-weight: 700; color: #636e72; }
        .pill-val { font-size: 1.4rem; font-weight: 900; color: var(--dark); line-height: 1; }

        #q-area { position: relative; margin: 10px 0; width: 100%; max-width: 450px; text-align: center; }
        .q-card {
            background: var(--dark); color: white; padding: 20px; border-radius: 30px;
            box-shadow: 0 10px 25px rgba(45, 52, 54, 0.4); margin-bottom: 15px;
            transition: transform 0.2s; position: relative; overflow: hidden;
        }
        .q-text { font-size: 3.5rem; font-weight: 900; font-family: 'Fredoka', sans-serif; letter-spacing: 2px; }
        .ans-preview {
            height: 50px; background: rgba(255,255,255,0.1); border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: 700; color: var(--secondary); margin-top: 10px;
            border: 2px dashed rgba(255,255,255,0.2);
        }
        
        /* Powerups */
        .powerup-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .pu-btn {
            width: 50px; height: 50px; border-radius: 15px; border: none; font-size: 1.5rem;
            background: white; box-shadow: 0 4px 0 #b2bec3; cursor: pointer; position: relative;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .pu-btn:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 1px 0 #b2bec3; }
        .pu-btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; transform: none; box-shadow: none; border: 1px solid #ddd; }
        .pu-badge { 
            position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; 
            font-size: 0.7rem; width: 18px; height: 18px; border-radius: 50%; font-weight: 800;
            display: flex; align-items: center; justify-content: center; 
        }

        /* Numpad */
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 400px; margin: 0 auto; }
        .num-btn {
            height: var(--btn-size); background: white; border-radius: 18px; border: none;
            font-size: 1.8rem; font-weight: 700; color: var(--dark); cursor: pointer;
            box-shadow: 0 5px 0 var(--light); transition: 0.1s;
        }
        .num-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 var(--light); }
        .num-btn.del { background: var(--accent); color: white; box-shadow: 0 5px 0 #e17055; font-size: 1.1rem; font-weight: 800; }
        
        /* Reactions - Moved to Top */
        .reaction-bar { 
            display: flex; gap: 5px; justify-content: center; margin: 0 0 10px 0; 
            background: rgba(255,255,255,0.4); padding: 5px; border-radius: 20px;
        }
        .react-btn {
            background: rgba(255,255,255,0.9); border: none; border-radius: 50%;
            width: 35px; height: 35px; font-size: 1.1rem; cursor: pointer; transition: 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .react-btn:hover { transform: scale(1.1); background: white; }
        .react-btn:disabled { opacity: 0.3; cursor: wait; }

        /* Effects */
        .floating-emoji {
            position: fixed; font-size: 4rem; pointer-events: none; z-index: 2000;
            animation: floatUp 2s forwards; left: 50%; top: 50%;
        }
        @keyframes floatUp { 0% { opacity: 0; transform: translate(-50%, 0) scale(0.5); } 20% { opacity: 1; transform: translate(-50%, -100px) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -300px) scale(1); } }

        .toast {
            position: fixed; top: 15%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 12px 25px; border-radius: 25px;
            font-weight: 700; font-size: 1.2rem; z-index: 9999; pointer-events: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        /* Animations */
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        
        .frozen-ui { filter: grayscale(1) blur(1px); pointer-events: none; opacity: 0.8; }
        .correct-answer-show { color: var(--success); font-size: 1.5rem; font-weight: 900; background: white; padding: 5px 10px; border-radius: 10px; margin-top: 5px; display: inline-block; }

    </style>
</head>
<body class="mode-tablet">

<button class="sound-toggle" onclick="toggleSound()">
    <span id="sound-icon">üîä</span>
</button>

<!-- IDENTITY SCREEN -->
<div id="identity-screen" class="screen">
    <div class="card">
        <h1>Kimsin?</h1>
        <p style="color:#636e72; margin-bottom:20px;">Yarƒ±≈ümaya ba≈ülamadan √∂nce profilini se√ß.</p>
        
        <div class="avatar-grid">
            <div class="avatar-opt selected" onclick="selectAvatar('üòé', this)">üòé</div>
            <div class="avatar-opt" onclick="selectAvatar('üöÄ', this)">üöÄ</div>
            <div class="avatar-opt" onclick="selectAvatar('ü¶Ñ', this)">ü¶Ñ</div>
            <div class="avatar-opt" onclick="selectAvatar('ü¶Å', this)">ü¶Å</div>
            <div class="avatar-opt" onclick="selectAvatar('üê±', this)">üê±</div>
        </div>

        <input type="text" id="player-name-input" class="inp-text" placeholder="ƒ∞smin (√ñrn: Ali)" maxlength="12">

        <button class="big-btn" onclick="saveIdentity()">DEVAM ET</button>
    </div>
</div>

<!-- SETUP SCREEN -->
<div id="setup-screen" class="screen hidden">
    <div class="card">
        <h1>Matematik Ustasƒ±</h1>
        <div style="font-weight:700; color:var(--primary); margin-bottom:15px;">Ho≈ü geldin, <span id="display-name">Oyuncu</span>!</div>

        <span class="section-title">Cihaz Modu</span>
        <div class="btn-group">
            <button class="opt-btn" onclick="setDevice('phone', this)">üì± Telefon</button>
            <button class="opt-btn active" onclick="setDevice('tablet', this)">üì≤ Tablet</button>
            <button class="opt-btn" onclick="setDevice('board', this)">üñ•Ô∏è Tahta</button>
        </div>

        <span class="section-title">Oyun Modu</span>
        <div class="btn-group">
            <button class="opt-btn" onclick="setMode('count', this)">üìù 20 Soru</button>
            <button class="opt-btn" onclick="setMode('survival', this)">üî• Zamana Kar≈üƒ±</button>
            <button class="opt-btn" style="background:#0984e3; color:white;" onclick="setMode('online', this)">üåç Online D√ºello</button>
        </div>
        <div id="mode-desc" style="font-size:0.8rem; color:#636e72; min-height:1.2rem; margin-bottom:10px;">Stres yok! 20 soruyu √ß√∂z.</div>

        <!-- SOLO OPTIONS -->
        <div id="solo-options">
            <span class="section-title">Zorluk</span>
            <div class="btn-group">
                <button class="opt-btn active" onclick="setDiff(1, this)">Kolay</button>
                <button class="opt-btn" onclick="setDiff(2, this)">Orta</button>
                <button class="opt-btn" onclick="setDiff(3, this)">Zor</button>
            </div>
            
            <span class="section-title">ƒ∞≈ülemler</span>
            <div class="btn-group">
                <button class="opt-btn active op-btn" onclick="toggleOp('+', this)">Toplama</button>
                <button class="opt-btn active op-btn" onclick="toggleOp('-', this)">√áƒ±karma</button>
                <button class="opt-btn op-btn" onclick="toggleOp('*', this)">√áarpma</button>
                <button class="opt-btn op-btn" onclick="toggleOp('/', this)">B√∂lme</button>
            </div>
            <button class="big-btn" onclick="startSoloGame()">OYUNA BA≈ûLA</button>
        </div>

        <!-- ONLINE OPTIONS -->
        <div id="online-options" class="hidden">
            <div style="background:#e3f2fd; padding:15px; border-radius:15px; margin-top:10px;">
                <div style="display:flex; gap:10px;">
                    <button class="big-btn btn-blue" style="margin:0; flex:1;" onclick="setupOnlineRoom()">ODA KUR</button>
                </div>
                <div style="margin:15px 0; font-weight:700; color:#b2bec3;">- VEYA -</div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <input id="room-join-code" type="number" class="inp-text" placeholder="Kod" style="font-size:1.5rem; width:120px;">
                    <button class="big-btn" style="margin:0; width:auto; padding:0 30px;" onclick="joinRoom()">KATIL</button>
                </div>
            </div>
        </div>

        <button class="big-btn btn-white" style="margin-top:10px; font-size:1rem;" onclick="showStats()">üèÜ Skorlar</button>
        
        <!-- Minimalist Signature -->
        <div class="dev-footer">&lt; <strong>Sami G√úREVƒ∞N</strong> /&gt;</div>
    </div>
</div>

<!-- ONLINE SETUP SCREEN (HOST ONLY) -->
<div id="online-setup-screen" class="screen hidden">
    <div class="card">
        <h2>Oda Ayarlarƒ±</h2>
        <p style="font-size:0.9rem; color:#636e72;">Rakibin gelmeden kurallarƒ± belirle.</p>

        <span class="section-title">S√ºre</span>
        <div class="btn-group">
            <button class="opt-btn active" onclick="setHostTime(60, this)">60sn</button>
            <button class="opt-btn" onclick="setHostTime(120, this)">120sn</button>
            <button class="opt-btn" onclick="setHostTime(180, this)">180sn</button>
        </div>

        <span class="section-title">Zorluk</span>
        <div class="btn-group">
            <button class="opt-btn active" onclick="setHostDiff(1, this)">Kolay</button>
            <button class="opt-btn" onclick="setHostDiff(2, this)">Orta</button>
            <button class="opt-btn" onclick="setHostDiff(3, this)">Zor</button>
        </div>

        <span class="section-title">ƒ∞≈ülemler (√áoklu Se√ßim)</span>
        <div class="btn-group">
            <button class="opt-btn active host-op-btn" onclick="toggleHostOp('+', this)">Topla</button>
            <button class="opt-btn active host-op-btn" onclick="toggleHostOp('-', this)">√áƒ±kar</button>
            <button class="opt-btn host-op-btn" onclick="toggleHostOp('*', this)">√áarp</button>
            <button class="opt-btn host-op-btn" onclick="toggleHostOp('/', this)">B√∂l</button>
        </div>

        <button class="big-btn btn-blue" onclick="createRoomFinal()">ODAYI OLU≈ûTUR</button>
        <button class="big-btn btn-white" style="margin-top:10px;" onclick="goHome()">ƒ∞ptal</button>
    </div>
</div>

<!-- LOBBY SCREEN -->
<div id="lobby-screen" class="screen hidden">
    <div class="card">
        <h2>Bekleme Odasƒ±</h2>
        <div class="lobby-code-box" onclick="copyCode()">
            <span id="lobby-code" class="lobby-code">----</span>
            <div class="copy-icon">üìã</div>
            <div id="copy-msg" style="position:absolute; bottom:-20px; font-size:0.7rem; color:var(--success);"></div>
        </div>
        
        <div id="lobby-settings" class="lobby-settings-box">
            <!-- Settings will be injected here -->
            Y√ºkleniyor...
        </div>

        <div class="player-list">
            <div class="player-row" id="p1-row">
                <div class="p-avatar" id="p1-av">üòé</div>
                <div class="p-name" id="p1-n">Sen</div>
                <div class="p-status" id="p1-s">Hazƒ±rlanƒ±yor</div>
            </div>
            <div class="player-row" id="p2-row">
                <div class="p-avatar" id="p2-av">üë§</div>
                <div class="p-name" id="p2-n">Rakip Bekleniyor...</div>
                <div class="p-status" id="p2-s">---</div>
            </div>
        </div>

        <div style="margin-top:20px; font-size:0.8rem; color:#e17055;" id="lobby-timer">Otomatik kapanƒ±≈ü: 3:00</div>

        <button id="lobby-ready-btn" class="big-btn" onclick="toggleReady()">HAZIRIM</button>
        <button class="big-btn btn-red" style="margin-top:10px;" onclick="leaveLobby()">ODADAN AYRIL</button>
    </div>
</div>

<!-- GAME SCREEN -->
<div id="game-screen" class="screen hidden" style="background:transparent;">
    <!-- Header -->
    <div id="game-header">
        <div class="score-pill" id="enemy-pill" style="opacity:0;">
            <span class="pill-label" id="enemy-name">Rakip</span>
            <span class="pill-val" id="enemy-score">0</span>
        </div>
        
        <div style="text-align:center;">
            <div style="font-size:2rem; font-weight:900;" id="timer-display">60</div>
            <div style="font-size:0.7rem; font-weight:700; color:#636e72;" id="game-mode-label">MOD</div>
        </div>

        <div class="score-pill">
            <span class="pill-label">Sen</span>
            <span class="pill-val" id="my-score">0</span>
        </div>
    </div>
    
    <!-- Reactions moved here (Top) -->
    <div class="reaction-bar hidden" id="reaction-bar">
        <button class="react-btn" onclick="sendReaction('üëè')">üëè</button>
        <button class="react-btn" onclick="sendReaction('üòÇ')">üòÇ</button>
        <button class="react-btn" onclick="sendReaction('üò≠')">üò≠</button>
        <button class="react-btn" onclick="sendReaction('üò°')">üò°</button>
        <button class="react-btn" onclick="sendReaction('üò±')">üò±</button>
    </div>

    <!-- Powerups -->
    <div id="powerup-bar" class="powerup-bar hidden">
        <button class="pu-btn" id="pu-shield" onclick="usePowerup('shield')" title="Kalkan (1 Hata Koru)">üõ°Ô∏è<span class="pu-badge">1</span></button>
        <button class="pu-btn" id="pu-x2" onclick="usePowerup('x2')" title="x2 Puan (Sonraki Doƒüru)">‚ö°<span class="pu-badge">1</span></button>
        <button class="pu-btn" id="pu-freeze" onclick="usePowerup('freeze')" title="Rakibi Dondur">‚ùÑÔ∏è<span class="pu-badge">1</span></button>
    </div>

    <!-- Question Area -->
    <div id="q-area">
        <div class="q-card" id="q-card">
            <div style="position:absolute; top:10px; right:15px; color:#fab1a0; font-weight:800; opacity:0;" id="streak-indicator">x2 üî•</div>
             <div style="position:absolute; top:10px; left:15px; color:#fab1a0; font-weight:800; opacity:0;" id="x2-indicator">2 KAT PUAN! ‚ö°</div>
            <div class="q-text" id="q-text">2 + 2</div>
            <div class="correct-answer-show hidden" id="correct-ans-display">Cevap: 4</div>
            <div class="ans-preview" id="ans-preview"></div>
        </div>
    </div>

    <!-- Numpad -->
    <div class="numpad" id="numpad">
        <button class="num-btn" onclick="input(1)">1</button>
        <button class="num-btn" onclick="input(2)">2</button>
        <button class="num-btn" onclick="input(3)">3</button>
        <button class="num-btn" onclick="input(4)">4</button>
        <button class="num-btn" onclick="input(5)">5</button>
        <button class="num-btn" onclick="input(6)">6</button>
        <button class="num-btn" onclick="input(7)">7</button>
        <button class="num-btn" onclick="input(8)">8</button>
        <button class="num-btn" onclick="input(9)">9</button>
        <button class="num-btn del" onclick="input('del')">Sƒ∞L</button>
        <button class="num-btn" style="grid-column: span 2;" onclick="input(0)">0</button>
    </div>

    <button class="big-btn btn-success" style="max-width:400px; margin-top:15px;" onclick="checkAnswer()">CEVAPLA</button>
</div>

<!-- RESULT SCREEN -->
<div id="result-screen" class="screen hidden">
    <canvas id="confetti" style="position:absolute; inset:0; pointer-events:none;"></canvas>
    <div class="card">
        <h1 id="res-title">Oyun Bitti!</h1>
        <div style="font-size:4rem; margin:10px 0;" id="res-emoji">üèÜ</div>
        
        <div id="solo-stats">
            <div style="font-size:3rem; font-weight:900; color:var(--primary);" id="res-score">0</div>
            <p style="color:#b2bec3; font-weight:700;">PUAN</p>
        </div>

        <div id="online-stats" class="hidden">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <div style="background:#f1f2f6; padding:10px; border-radius:15px;">
                    <div id="end-p1-name" style="font-weight:700; color:var(--primary)">Sen</div>
                    <div id="end-p1-score" style="font-size:1.5rem; font-weight:900;">0</div>
                </div>
                <div style="background:#f1f2f6; padding:10px; border-radius:15px;">
                    <div id="end-p2-name" style="font-weight:700; color:var(--danger)">Rakip</div>
                    <div id="end-p2-score" style="font-size:1.5rem; font-weight:900;">0</div>
                </div>
            </div>
            <div id="res-msg" style="font-size:1.2rem; font-weight:800; color:var(--success);">Kazandƒ±n!</div>
        </div>
        
        <button id="btn-rematch" class="big-btn btn-blue hidden" onclick="requestRematch()">TEKRAR YARI≈û</button>
        <button id="btn-res-home" class="big-btn btn-white" style="margin-top:10px;" onclick="goHome()">ANA SAYFA</button>
        <div id="rematch-status" style="margin-top:10px; font-size:0.8rem; color:#636e72; min-height:1rem;"></div>
    </div>
</div>

<!-- STATS SCREEN -->
<div id="stats-screen" class="screen hidden">
    <div class="card">
        <h2>ƒ∞statistikler</h2>
        <div style="font-size:3rem;">üèÖ</div>
        <p style="margin-bottom:20px;">En Y√ºksek Puan: <strong id="stat-best" style="color:var(--success)">0</strong></p>
        <p>Toplam Oyun: <span id="stat-games">0</span></p>
        <p>Toplam Doƒüru: <span id="stat-correct">0</span></p>
        <button class="big-btn" onclick="goHome()">KAPAT</button>
        <button class="big-btn btn-red" style="margin-top:10px; font-size:0.9rem;" onclick="clearStats()">SIFIRLA</button>
    </div>
</div>

<div id="countdown-overlay" class="screen hidden" style="background:rgba(255,255,255,0.9); font-size:8rem; font-weight:900; color:var(--primary); z-index:5000;">3</div>

<!-- Firebase & Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getDatabase, ref, set, onValue, update, remove, get, onDisconnect, off } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD4zIUFTJEzFrDc6UTKTRPFtAvsM3t97z0",
    authDomain: "matematik-ustasi.firebaseapp.com",
    databaseURL: "https://matematik-ustasi-default-rtdb.firebaseio.com",
    projectId: "matematik-ustasi",
    storageBucket: "matematik-ustasi.firebasestorage.app",
    messagingSenderId: "748610525562",
    appId: "1:748610525562:web:3d1c0396f47f465f8a9ec3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  /* --- GLOBAL STATE --- */
  let config = { diff: 1, ops: ['+', '-'], mode: 'count', device: 'tablet' }; // count, survival, online
  let hostConfig = { time: 60, diff: 1, ops: ['+', '-'] }; // Host default
  
  let state = {
      active: false, paused: false, frozen: false,
      score: 0, time: 0, 
      qIndex: 0, currentQ: {}, input: '', 
      streak: 0,
      shieldActive: false,
      doublePoints: false, // New Joker
      
      // Online
      isOnline: false, roomCode: null, role: null, // p1 (host), p2 (guest)
      oppScore: 0, oppName: 'Rakip', oppAvatar: 'üë§',
      isReady: false,
      
      // Identity
      identity: { name: 'Oyuncu', avatar: 'üòé' }
  };
  
  let lobbyTimeout, gameTimer;
  let lastReactTime = 0;
  let lastEventTime = 0;
  let activeRoomListener = null; 
  
  let stats = JSON.parse(localStorage.getItem('mu_stats')) || { best: 0, games: 0, correct: 0 };
  let soundEnabled = true;

  /* --- INITIALIZATION --- */
  function init() {
      const savedId = JSON.parse(localStorage.getItem('mu_id'));
      if(savedId) {
          state.identity = savedId;
          document.getElementById('player-name-input').value = savedId.name;
          document.getElementById('display-name').textContent = savedId.name;
          showScreen('setup-screen');
      } else {
          showScreen('identity-screen');
      }
      
      document.querySelectorAll('.avatar-opt').forEach(el => {
          if(el.textContent === state.identity.avatar) el.classList.add('selected');
          else el.classList.remove('selected');
      });
  }

  /* --- AUDIO --- */
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSound(type) {
      if (!soundEnabled) return;
      if (audioCtx.state === 'suspended') audioCtx.resume();
      
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      
      if (type === 'click') {
          osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.05);
          gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.05);
          osc.start(now); osc.stop(now + 0.05);
      } else if (type === 'correct') {
          osc.type = 'sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.exponentialRampToValueAtTime(1000, now + 0.2);
          gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
          osc.start(now); osc.stop(now + 0.3);
      } else if (type === 'wrong') {
          osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3);
          gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
          osc.start(now); osc.stop(now + 0.3);
      } else if (type === 'win') {
          osc.type = 'square'; osc.frequency.setValueAtTime(400, now); osc.frequency.setValueAtTime(600, now + 0.1);
          gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
          osc.start(now); osc.stop(now + 0.5);
      }
  }
  window.toggleSound = () => { soundEnabled = !soundEnabled; document.getElementById('sound-icon').textContent = soundEnabled ? 'üîä' : 'üîá'; };

  /* --- NAVIGATION --- */
  window.showScreen = (id) => {
      document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
      const el = document.getElementById(id);
      el.classList.remove('hidden');
      el.style.opacity = 0; setTimeout(() => el.style.opacity = 1, 50);
      playSound('click');
  };
  
  window.goHome = () => {
      try {
          stopGame();
          if(state.isOnline) leaveLobby();
      } catch(e) { console.error(e); }
      showScreen('setup-screen');
  };

  /* --- SETTINGS --- */
  window.saveIdentity = () => {
      const name = document.getElementById('player-name-input').value.trim() || "Oyuncu";
      state.identity.name = name;
      localStorage.setItem('mu_id', JSON.stringify(state.identity));
      document.getElementById('display-name').textContent = name;
      showScreen('setup-screen');
  };

  window.selectAvatar = (av, btn) => {
      state.identity.avatar = av;
      document.querySelectorAll('.avatar-opt').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected'); playSound('click');
  };

  window.setDevice = (dev, btn) => { document.body.className = `mode-${dev}`; updateBtnGroup(btn); };
  window.setMode = (m, btn) => {
      config.mode = m; updateBtnGroup(btn);
      const desc = document.getElementById('mode-desc');
      const soloOpts = document.getElementById('solo-options');
      const onlineOpts = document.getElementById('online-options');
      if(m === 'count') { desc.textContent = "Stres yok! 20 soruyu kendi hƒ±zƒ±nda √ß√∂z."; soloOpts.classList.remove('hidden'); onlineOpts.classList.add('hidden'); } 
      else if (m === 'survival') { desc.textContent = "Doƒüru cevap s√ºre kazandƒ±rƒ±r, yanlƒ±≈ü kaybettirir."; soloOpts.classList.remove('hidden'); onlineOpts.classList.add('hidden'); } 
      else { desc.textContent = "Arkada≈üƒ±nla e≈ü zamanlƒ± yarƒ±≈ü. En y√ºksek puanƒ± toplayan kazanƒ±r!"; soloOpts.classList.add('hidden'); onlineOpts.classList.remove('hidden'); }
      playSound('click');
  };

  window.setDiff = (d, btn) => { config.diff = d; updateBtnGroup(btn); playSound('click'); };
  window.toggleOp = (op, btn) => {
      if(config.ops.includes(op) && config.ops.length > 1) { config.ops = config.ops.filter(o => o !== op); btn.classList.remove('active'); } 
      else if (!config.ops.includes(op)) { config.ops.push(op); btn.classList.add('active'); }
      playSound('click');
  };

  function updateBtnGroup(btn) {
      Array.from(btn.parentElement.children).forEach(c => {
          if(!c.classList.contains('op-btn') && !c.classList.contains('host-op-btn')) c.classList.remove('active');
      });
      btn.classList.add('active');
  }

  /* --- ONLINE HOST SETUP --- */
  window.setupOnlineRoom = () => { showScreen('online-setup-screen'); };
  window.setHostTime = (t, btn) => { hostConfig.time = t; updateBtnGroup(btn); playSound('click'); };
  window.setHostDiff = (d, btn) => { hostConfig.diff = d; updateBtnGroup(btn); playSound('click'); };
  
  // New: Host Multi-Op Selection
  window.toggleHostOp = (op, btn) => {
       if(hostConfig.ops.includes(op) && hostConfig.ops.length > 1) {
           hostConfig.ops = hostConfig.ops.filter(o => o !== op);
           btn.classList.remove('active');
       } else if (!hostConfig.ops.includes(op)) {
           hostConfig.ops.push(op);
           btn.classList.add('active');
       }
       playSound('click');
  };

  window.createRoomFinal = () => {
      const code = Math.floor(10000 + Math.random() * 90000);
      state.roomCode = code; state.role = 'p1'; state.isOnline = true; state.isReady = false;
      
      config.diff = hostConfig.diff; config.ops = hostConfig.ops;

      set(ref(db, 'rooms/' + code), {
          status: 'waiting',
          config: { time: hostConfig.time, diff: hostConfig.diff, ops: hostConfig.ops },
          players: { p1: { name: state.identity.name, avatar: state.identity.avatar, ready: false, score: 0 } },
          ts: Date.now()
      });
      onDisconnect(ref(db, 'rooms/' + code)).remove();
      enterLobby(code);
  };

  /* --- ONLINE JOIN --- */
  window.joinRoom = () => {
      const code = document.getElementById('room-join-code').value;
      if(!code) return showToast("Kod girin!");
      
      get(ref(db, 'rooms/' + code)).then(snap => {
          if(snap.exists()) {
              const data = snap.val();
              if(data.status === 'waiting' && !data.players.p2) {
                  state.roomCode = code; state.role = 'p2'; state.isOnline = true; state.isReady = false;
                  config.diff = data.config.diff; config.ops = data.config.ops;
                  
                  update(ref(db, 'rooms/' + code + '/players/p2'), { name: state.identity.name, avatar: state.identity.avatar, ready: false, score: 0 });
                  onDisconnect(ref(db, 'rooms/' + code + '/players/p2')).remove();
                  enterLobby(code);
              } else { showToast("Oda dolu veya oyun ba≈ülamƒ±≈ü!"); }
          } else { showToast("Oda bulunamadƒ±!"); }
      });
  };

  /* --- LOBBY LOGIC --- */
  function enterLobby(code) {
      showScreen('lobby-screen');
      document.getElementById('lobby-code').textContent = code;
      
      clearTimeout(lobbyTimeout);
      lobbyTimeout = setTimeout(() => { if(!state.active) { alert("S√ºre doldu! Oda kapatƒ±lƒ±yor."); leaveLobby(); } }, 180000);

      const roomRef = ref(db, 'rooms/' + code);
      activeRoomListener = onValue(roomRef, snap => {
          const data = snap.val();
          if(!data) {
              if(state.isOnline && !state.active) { alert("Oda kapatƒ±ldƒ±."); goHome(); }
              else if (state.active) { showToast("Rakip Ayrƒ±ldƒ±!"); endGameOnline(true); }
              return;
          }
          
          updateLobbyUI(data.players);
          // NEW: Update Lobby Settings Display
          updateLobbySettings(data.config);

          if(state.role === 'p1' && data.status === 'waiting' && data.players?.p1?.ready && data.players?.p2?.ready) {
              update(ref(db, 'rooms/' + code), { status: 'playing' });
              generateNextOnlineQ();
          }
          
          if(data.status === 'playing' && !state.active) { startOnlineGame(data.config.time); }
          if(state.active) { handleGameSync(data); }
      });
  }

  function updateLobbySettings(cfg) {
      if(!cfg) return;
      const opsNames = cfg.ops.map(o => o==='+'?'Toplama':(o==='-'?'√áƒ±karma':(o==='*'?'√áarpma':'B√∂lme'))).join(', ');
      const diffName = cfg.diff===1?'Kolay':(cfg.diff===2?'Orta':'Zor');
      document.getElementById('lobby-settings').innerHTML = `
          <strong>Oyun Ayarlarƒ±:</strong><br>
          S√ºre: ${cfg.time}sn | Zorluk: ${diffName}<br>
          ƒ∞≈ülemler: ${opsNames}
      `;
  }

  function updateLobbyUI(players) {
      if(!players) return;
      const p1 = players.p1; const p2 = players.p2;
      if(p1) {
          document.getElementById('p1-n').textContent = p1.name;
          document.getElementById('p1-av').textContent = p1.avatar;
          document.getElementById('p1-row').classList.toggle('ready', p1.ready);
          document.getElementById('p1-s').innerHTML = p1.ready ? '<span class="badge-ready">HAZIR</span>' : 'Bekliyor...';
      }
      if(p2) {
          document.getElementById('p2-n').textContent = p2.name;
          document.getElementById('p2-av').textContent = p2.avatar;
          document.getElementById('p2-row').classList.toggle('ready', p2.ready);
          document.getElementById('p2-s').innerHTML = p2.ready ? '<span class="badge-ready">HAZIR</span>' : 'Bekliyor...';
      } else {
          document.getElementById('p2-n').textContent = "Rakip Bekleniyor...";
          document.getElementById('p2-s').textContent = "---";
          document.getElementById('p2-row').classList.remove('ready');
      }
  }

  window.toggleReady = () => {
      state.isReady = !state.isReady;
      const btn = document.getElementById('lobby-ready-btn');
      btn.textContent = state.isReady ? "HAZIR (ƒ∞ptal)" : "HAZIRIM";
      btn.style.background = state.isReady ? "#b2bec3" : "var(--success)";
      update(ref(db, 'rooms/' + state.roomCode + '/players/' + state.role), { ready: state.isReady });
      playSound('click');
  };

  window.leaveLobby = () => {
      try {
          if (activeRoomListener && state.roomCode) { off(ref(db, 'rooms/' + state.roomCode), 'value', activeRoomListener); }
          if(state.roomCode) {
              if(state.role === 'p1') remove(ref(db, 'rooms/' + state.roomCode));
              else update(ref(db, 'rooms/' + state.roomCode + '/players/p2'), null);
          }
      } catch(e) { console.log("Lobby exit error", e); }
      state.isOnline = false; state.active = false;
      goHome();
  };
  
  window.copyCode = () => {
      navigator.clipboard.writeText(state.roomCode);
      const msg = document.getElementById('copy-msg');
      msg.textContent = "Kopyalandƒ±!";
      setTimeout(()=> msg.textContent = "", 2000);
  };

  /* --- GAME LOGIC --- */
  window.startSoloGame = () => {
      state.active = true; state.isOnline = false;
      state.score = 0; state.streak = 0; state.qIndex = 0;
      state.frozen = false; state.shieldActive = false; state.doublePoints = false;
      
      if(config.mode === 'count') state.time = 0; else state.time = 60;
      
      document.getElementById('enemy-pill').style.opacity = 0;
      document.getElementById('powerup-bar').classList.add('hidden');
      document.getElementById('reaction-bar').classList.add('hidden');
      document.getElementById('game-mode-label').textContent = config.mode === 'count' ? '20 SORU' : 'ZAMANA KAR≈ûI';
      
      startCountdown(() => { showScreen('game-screen'); nextQuestion(); gameTimer = setInterval(gameLoop, 1000); });
  };

  function startOnlineGame(duration) {
      if(state.active) return;
      state.active = true;
      state.score = 0; state.streak = 0; state.frozen = false;
      state.time = duration; state.shieldActive = false; state.doublePoints = false;
      
      document.getElementById('powerup-bar').classList.remove('hidden');
      document.getElementById('reaction-bar').classList.remove('hidden');
      document.getElementById('enemy-pill').style.opacity = 1;
      document.getElementById('game-mode-label').textContent = 'D√úELLO';
      
      get(ref(db, 'rooms/' + state.roomCode + '/players')).then(snap => {
          const pl = snap.val();
          if(pl) {
              const oppRole = state.role === 'p1' ? 'p2' : 'p1';
              state.oppName = pl[oppRole] ? pl[oppRole].name : 'Rakip';
              document.getElementById('enemy-name').textContent = state.oppName;
          }
      });
      startCountdown(() => { showScreen('game-screen'); gameTimer = setInterval(gameLoop, 1000); });
  }

  function startCountdown(cb) {
      const el = document.getElementById('countdown-overlay'); el.classList.remove('hidden');
      let c = 3; el.textContent = c; playSound('click');
      const int = setInterval(() => { c--; if(c > 0) { el.textContent = c; playSound('click'); } else { clearInterval(int); el.classList.add('hidden'); cb(); } }, 1000);
  }

  function gameLoop() {
      if(state.paused) return;
      if(config.mode === 'count') { state.time++; document.getElementById('timer-display').textContent = state.time; } 
      else { state.time--; document.getElementById('timer-display').textContent = state.time; if(state.time <= 0) endGame(); }
  }

  window.nextQuestion = () => {
      let currentDiff = config.diff;
      if(config.mode === 'survival') {
          if(state.score > 500) currentDiff = 3; else if(state.score > 200) currentDiff = 2;
      }
      const op = config.ops[Math.floor(Math.random() * config.ops.length)];
      let n1, n2, ans, symbol = op;
      const max = currentDiff * 15; 
      
      if(op === '+') { n1 = r(max) + 2; n2 = r(max) + 2; ans = n1 + n2; } 
      else if (op === '-') { n1 = r(max) + 5; n2 = r(n1-2) + 1; ans = n1 - n2; } 
      else if (op === '*') { symbol = 'x'; const mMax = currentDiff === 1 ? 5 : (currentDiff === 2 ? 9 : 12); n1 = r(mMax) + 2; n2 = r(mMax) + 2; ans = n1 * n2; } 
      else { symbol = '√∑'; const dMax = currentDiff === 1 ? 5 : 10; ans = r(dMax) + 2; n2 = r(dMax) + 2; n1 = ans * n2; }
      
      state.currentQ = { text: `${n1} ${symbol} ${n2}`, ans: ans };
      renderQuestion();
  };

  function generateNextOnlineQ() {
      if(state.role !== 'p1') return;
      const op = config.ops[Math.floor(Math.random() * config.ops.length)];
      let n1, n2, ans, symbol = op;
      const max = config.diff * 15;

      if(op === '+') { n1 = r(max) + 2; n2 = r(max) + 2; ans = n1 + n2; } 
      else if (op === '-') { n1 = r(max) + 5; n2 = r(n1-2) + 1; ans = n1 - n2; } 
      else if (op === '*') { symbol = 'x'; const m = config.diff===1?5:9; n1=r(m)+2; n2=r(m)+2; ans=n1*n2; } 
      else { symbol = '√∑'; const d = config.diff===1?5:10; ans=r(d)+2; n2=r(d)+2; n1=ans*n2; }

      update(ref(db, 'rooms/' + state.roomCode), { currentQuestion: { text: `${n1} ${symbol} ${n2}`, ans: ans, id: Date.now() } });
  }

  function renderQuestion() {
      document.getElementById('q-text').textContent = state.currentQ.text;
      state.input = ''; updateInput();
      const card = document.getElementById('q-card'); card.classList.remove('shake', 'pop');
      document.getElementById('numpad').classList.remove('frozen-ui');
      document.getElementById('correct-ans-display').classList.add('hidden');
  }

  function r(m) { return Math.floor(Math.random() * m); }

  window.input = (v) => {
      if(state.frozen || state.paused) return;
      if(v === 'del') state.input = state.input.slice(0, -1);
      else if(state.input.length < 5) state.input += v;
      updateInput();
      playSound('click');
  };

  function updateInput() {
      const el = document.getElementById('ans-preview');
      el.textContent = state.input;
      el.style.color = state.input ? 'var(--dark)' : 'var(--secondary)';
  }

  window.checkAnswer = () => {
      if(!state.input || state.frozen) return;
      const val = parseInt(state.input);
      
      if(val === state.currentQ.ans) {
          playSound('correct');
          
          let points = 10 + (state.streak * 2);
          if(state.doublePoints) {
              points *= 2;
              state.doublePoints = false;
              showToast("2 KAT PUAN! ‚ö°");
              document.getElementById('x2-indicator').style.opacity = 0;
          }
          state.score += points;
          state.streak++;
          if(config.mode === 'survival') state.time += 3;
          
          showToast("DOƒûRU! ‚úÖ");
          
          if(state.isOnline) {
              update(ref(db, 'rooms/' + state.roomCode + '/players/' + state.role), { score: state.score });
              update(ref(db, 'rooms/' + state.roomCode + '/latestEvent'), { type: 'answer', who: state.role, name: state.identity.name, qId: state.currentQ.id, ts: Date.now() });
              if(state.role === 'p1') generateNextOnlineQ();
          } else {
              if(config.mode === 'count') { state.qIndex++; if(state.qIndex >= 20) endGame(); else nextQuestion(); } 
              else { nextQuestion(); }
          }
      } else {
          if(state.shieldActive) { showToast("Kalkan Korudu! üõ°Ô∏è"); state.shieldActive = false; state.input = ''; updateInput(); return; }
          playSound('wrong'); state.streak = 0;
          if(config.mode === 'survival') state.time -= 5;
          handleWrong();
      }
      updateHUD();
  };

  function handleWrong() {
      state.frozen = true;
      document.getElementById('q-card').classList.add('shake');
      document.getElementById('numpad').classList.add('frozen-ui');
      const ca = document.getElementById('correct-ans-display'); ca.textContent = "Cevap: " + state.currentQ.ans; ca.classList.remove('hidden');
      showToast("DONDU! üßä");
      setTimeout(() => {
          if(!state.active) return;
          state.frozen = false;
          document.getElementById('numpad').classList.remove('frozen-ui');
          if(!state.isOnline) nextQuestion(); 
          else { state.input = ''; updateInput(); ca.classList.add('hidden'); }
      }, 2000);
  }

  function updateHUD() {
      document.getElementById('my-score').textContent = state.score;
      const s = document.getElementById('streak-indicator');
      if(state.streak > 1) { s.style.opacity = 1; s.textContent = `x${state.streak} üî•`; } else { s.style.opacity = 0; }
  }

  /* --- ONLINE SYNC --- */
  function handleGameSync(data) {
      const oppRole = state.role === 'p1' ? 'p2' : 'p1';
      const oppData = data.players?.[oppRole];
      if(oppData) { state.oppScore = oppData.score || 0; document.getElementById('enemy-score').textContent = state.oppScore; }

      if(data.currentQuestion && data.currentQuestion.id !== state.currentQ.id) { state.currentQ = data.currentQuestion; renderQuestion(); }

      if(data.latestEvent && data.latestEvent.ts > lastEventTime) {
          lastEventTime = data.latestEvent.ts;
          const ev = data.latestEvent;
          if(ev.type === 'answer') {
              if(ev.who !== state.role) { showToast(`${ev.name} Bƒ∞LDƒ∞! üöÄ`); }
              if(state.role === 'p1' && ev.who !== 'p1') { setTimeout(() => generateNextOnlineQ(), 800); }
          }
          if(ev.type === 'freeze' && ev.target === state.role) { showToast("RAKƒ∞P SENƒ∞ DONDURDU! ‚ùÑÔ∏è"); handleWrong(); }
      }

      if(data.reaction && data.reaction.ts > lastReactTime && data.reaction.from !== state.role) {
          lastReactTime = data.reaction.ts; showFloatingEmoji(data.reaction.emoji);
      }
      if(data.status === 'finished') { endGameOnline(false); }
  }

  /* --- POWERUPS --- */
  window.usePowerup = (type) => {
      const btn = document.getElementById('pu-' + type);
      if(btn.disabled) return;
      btn.disabled = true; 
      
      if(type === 'shield') { state.shieldActive = true; showToast("Kalkan Aktif! üõ°Ô∏è"); } 
      else if (type === 'x2') { 
          state.doublePoints = true; 
          showToast("x2 Puan Hazƒ±r! ‚ö°"); 
          document.getElementById('x2-indicator').style.opacity = 1;
      } 
      else if (type === 'freeze' && state.isOnline) {
          const oppRole = state.role === 'p1' ? 'p2' : 'p1';
          update(ref(db, 'rooms/' + state.roomCode + '/latestEvent'), { type: 'freeze', target: oppRole, ts: Date.now() });
      }
  };

  window.sendReaction = (emoji) => {
      const btn = document.querySelector('.react-btn');
      if(Date.now() - (btn.dataset.last || 0) < 3000) return;
      btn.dataset.last = Date.now();
      showFloatingEmoji(emoji);
      if(state.isOnline) { update(ref(db, 'rooms/' + state.roomCode + '/reaction'), { emoji: emoji, from: state.role, ts: Date.now() }); }
  };

  function showFloatingEmoji(emoji) {
      const el = document.createElement('div'); el.className = 'floating-emoji'; el.textContent = emoji;
      document.body.appendChild(el); setTimeout(() => el.remove(), 2000);
  }

  function showToast(msg) {
      const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg;
      document.body.appendChild(t); setTimeout(() => t.remove(), 1500);
  }

  function endGame() {
      stopGame();
      if(state.isOnline) { update(ref(db, 'rooms/' + state.roomCode), { status: 'finished' }); } else { showResultsSolo(); }
  }

  function endGameOnline(abrupt) {
      stopGame();
      showScreen('result-screen');
      document.getElementById('solo-stats').classList.add('hidden');
      document.getElementById('online-stats').classList.remove('hidden');
      
      document.getElementById('end-p1-score').textContent = state.score;
      document.getElementById('end-p2-score').textContent = state.oppScore;
      document.getElementById('end-p2-name').textContent = state.oppName;

      const title = document.getElementById('res-title');
      const msg = document.getElementById('res-msg');
      const btn = document.getElementById('btn-rematch');
      const btnHome = document.getElementById('btn-res-home');
      
      btnHome.classList.remove('hidden'); btnHome.style.pointerEvents = "auto";
      
      if(abrupt) {
          title.textContent = "Rakip Ayrƒ±ldƒ±"; msg.textContent = "H√ºkmen Galipsin!"; btn.classList.add('hidden');
      } else {
          btn.classList.remove('hidden');
          if(state.score > state.oppScore) { msg.textContent = "KAZANDIN! üéâ"; startConfetti(); playSound('win'); } 
          else if (state.score < state.oppScore) { msg.textContent = "Kaybettin..."; msg.style.color = "var(--danger)"; } 
          else { msg.textContent = "Berabere!"; msg.style.color = "var(--primary)"; }
      }
      listenRematch();
  }

  function showResultsSolo() {
      showScreen('result-screen');
      document.getElementById('solo-stats').classList.remove('hidden');
      document.getElementById('online-stats').classList.add('hidden');
      document.getElementById('res-score').textContent = state.score;
      document.getElementById('btn-rematch').classList.add('hidden');
      
      if(state.score > stats.best) { stats.best = state.score; document.getElementById('res-msg').textContent = "YENƒ∞ REKOR! üî•"; startConfetti(); playSound('win'); }
      stats.games++; stats.correct += Math.floor(state.score / 10);
      localStorage.setItem('mu_stats', JSON.stringify(stats));
  }

  function stopGame() { state.active = false; clearInterval(gameTimer); }

  function listenRematch() {
      if(!state.isOnline) return;
      onValue(ref(db, 'rooms/' + state.roomCode + '/rematch'), snap => {
          const val = snap.val() || {};
          const s = document.getElementById('rematch-status');
          if(val.p1 && val.p2) {
              s.textContent = "Yeniden Ba≈ülƒ±yor...";
              if(state.role === 'p1') {
                   update(ref(db, 'rooms/' + state.roomCode), {
                       status: 'playing', rematch: null,
                       players: { p1: { score:0, ready:true, name:state.identity.name, avatar:state.identity.avatar }, p2: { score:0, ready:true, name:state.oppName, avatar:state.oppAvatar } }
                   });
                   generateNextOnlineQ();
              }
          } else if (val[state.role === 'p1' ? 'p2' : 'p1']) { s.textContent = `${state.oppName} tekrar istiyor!`; }
      });
  }

  window.requestRematch = () => {
      document.getElementById('btn-rematch').classList.add('hidden');
      document.getElementById('rematch-status').textContent = "ƒ∞stek g√∂nderildi...";
      update(ref(db, 'rooms/' + state.roomCode + '/rematch/' + state.role), true);
  };

  /* --- STATS & CONFETTI --- */
  window.showStats = () => {
      document.getElementById('stat-best').textContent = stats.best;
      document.getElementById('stat-games').textContent = stats.games;
      document.getElementById('stat-correct').textContent = stats.correct;
      showScreen('stats-screen');
  };
  window.clearStats = () => { stats = { best:0, games:0, correct:0 }; localStorage.setItem('mu_stats', JSON.stringify(stats)); showStats(); };

  function startConfetti() {
      const canvas = document.getElementById('confetti'); const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth; canvas.height = window.innerHeight;
      const p = []; for(let i=0; i<100; i++) p.push({x:Math.random()*canvas.width, y:-10, v:Math.random()*5+2, c:'#'+Math.floor(Math.random()*16777215).toString(16)});
      function draw() {
          ctx.clearRect(0,0,canvas.width,canvas.height);
          p.forEach(part => { part.y += part.v; ctx.fillStyle = part.c; ctx.fillRect(part.x, part.y, 8, 8); if(part.y > canvas.height) part.y = -10; });
          if(document.getElementById('result-screen').style.opacity === '1') requestAnimationFrame(draw);
      }
      draw();
  }
  
  init();
</script>
</body>
</html>
